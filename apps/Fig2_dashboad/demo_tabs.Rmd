---
title: "Untreated samples: NOKS+EBV vs NOKS"
output:
  flexdashboard::flex_dashboard:
    theme: yeti
runtime: shiny
---

```{r global,include=TRUE,echo = FALSE,eval = TRUE}

load("fig2data.RData")

## block to check if the packages are installed
list.of.packages <- c("tidyverse","ggrepel","viridis","scales","shiny",
                      "rmarkdown","flexdashboard")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

library(tidyverse)
library(ggrepel)
library(viridis)
library(scales)
library(shiny)
library(d3heatmap)

theme_set(
  theme_bw()+
    theme(legend.position = "top",
          axis.text = element_text(size = 14),
          axis.title = element_text(size = 16))
)

MA_tpm = rsem_data %>% 
  filter(treatment == "none") %>% 
  select(file,cell,rsem) %>% 
  unnest() %>% 
  group_by(cell,gene_id) %>% 
  summarize(
    tpm = mean(TPM)
  ) %>% 
  ungroup() %>% 
  spread(cell,tpm) %>% 
  mutate_if(
    is.numeric,
    funs(log2(1 + .))
  ) %>% 
  mutate(
    A = 0.5 * (EBV + NOKS),
    M = EBV - NOKS
  )

diff_genes = inner_join(
  diff_genes,
  MA_tpm,by = "gene_id"
) %>% 
  separate(gene_id,into = c("ensembl","gene_id"),sep = "\\_") %>% 
  mutate(
    log10pval = -log10(pvalue)
  )

stri_subset = function(string,pattern)
{
  string[! str_detect(string,pattern)]
}

rlogmat1 = rlogmat[, colnames(rlogmat) %>% 
                    stri_subset("MC")]

tpmmat1 = rsem_data %>% 
  filter(cell == "NOKS") %>% 
  select(file,rsem) %>% 
  unnest() %>% 
  select(file,gene_id,TPM) %>% 
  spread(file,TPM) %>% 
  as.data.frame() %>% 
  tibble::remove_rownames() %>% 
  tibble::column_to_rownames("gene_id") %>% 
  as.matrix()

```
    
Inputs {.sidebar}
-------------------------------------

```{r sidebar}
# shiny inputs defined here

  numericInput("fdr","False Discovery Rate",0.05,
               min = 1e-6,max = 1,step = .01)
  numericInput("ps","Point size",4,
               min = .5,max = 20,step = .5)
  
  hr()
  
  actionButton("clean","Clean Gene List")
  
  radioButtons("heatmap_type", "Heatmap type type",
            c("most DE", "selected"), inline = TRUE)
  
  numericInput("heatmap_most","Most DE genes",10,
               min = 5,max = 100,step = 1)
  
  ## action button events  
  #  ntext <- eventReactive(input$goButton, {
  #   input$n
  # })
  # 
  # output$nText <- renderText({
  #   ntext()
  # })
  
  observeEvent(input$clean,{
    my_genes$ensembl <- NULL
  })
  
```

   
Column {.tabset}
-------------------------------------
   
### Alignment

```{r alignment}

alignment %>% 
    ggplot(
        aes(aligned,aligned_percent))+
    geom_point()+
    geom_text_repel(aes(label = replicate))+
    facet_grid(treat ~ cell)+
    theme(axis.text.x = element_text(angle = 25,
                                     hjust = 1))+
    scale_x_continuous(
        labels = comma)+
    scale_y_continuous(
        labels = percent)+
    xlab("Number of aligned reads")+
    ylab("Percentage of aligned reads")
```   

### p.value

```{r pval_histogram}

diff_genes %>% 
    ggplot(aes(pvalue))+
    geom_histogram(aes(y = ..count../sum(..count..) ),
                   boundary = 0 , 
                   fill = "white",
                   color = "black",
                 bins = 51)+
  geom_hline(yintercept = 0.015,linetype = 2,colour = "red")

```

### Volcano
    
```{r volcano}

volcano_ranges <- reactiveValues(x = NULL, y = NULL)
my_genes <- reactiveValues(ensembl = NULL)

observeEvent(input$volcano_dblclick, {
  brush <- input$volcano_brush
  if (!is.null(brush)) {
    volcano_ranges$x <- c(brush$xmin, brush$xmax)
    volcano_ranges$y <- c(brush$ymin, brush$ymax)
    volcano_ranges$y[1] <- max(volcano_ranges$y[1],0)
  } else {
    volcano_ranges$x <- NULL
    volcano_ranges$y <- NULL
  }
})


observeEvent(input$volcano_click,{
  ff <- nearPoints(diff_genes,input$volcano_click)
  my_genes$ensembl <- c(my_genes$ensembl, ff$ensembl)
})

output$volcano = renderPlot({
  
  gene_data = diff_genes %>% 
    filter(ensembl %in% my_genes$ensembl)

  diff_genes %>%
    ggplot(aes(log2FoldChange,log10pval,
               colour = if_else(padj <= input$fdr,"yes","no")))+
    geom_point(size = input$ps,alpha = .75)+
    geom_text_repel(data = gene_data,aes(label = gene_id),colour = "black",
                    size = 4)+
    scale_color_brewer(palette = "Set1",name = "Diff. Expressed")+
    coord_cartesian(
      xlim = volcano_ranges$x ,
      ylim = volcano_ranges$y
    )+
    ylab("-log10(pvalue)")
})

fillCol(flex = c(1,NA),
        plotOutput("volcano",
                   click = "volcano_click",
                   dblclick = "volcano_dblclick",
                   brush = brushOpts(
                     id = "volcano_brush",
                     resetOnNew = TRUE
                     ))
        )


```

### MA - DESeq

```{r ma_deseq}

MA1_ranges <- reactiveValues(x = NULL, y = NULL)

observeEvent(input$MA1_dblclick, {
  brush <- input$MA1_brush
  if (!is.null(brush)) {
    MA1_ranges$x <- c(brush$xmin, brush$xmax)
    MA1_ranges$x[1] <- max(0 , MA1_ranges$x[1])
    MA1_ranges$y <- c(brush$ymin, brush$ymax)
  } else {
    MA1_ranges$x <- NULL
    MA1_ranges$y <- NULL
  }
})

observeEvent(input$MA1_click,{
  ff <- nearPoints(diff_genes,input$MA1_click)
  my_genes$ensembl <- c(my_genes$ensembl, ff$ensembl)
})

output$MA1 = renderPlot({
  
  gene_data = diff_genes %>% 
    filter(ensembl %in% my_genes$ensembl)
  
  diff_genes %>% 
    ggplot(aes(baseMean,log2FoldChange))+
    scale_color_brewer(palette = "Set1",name = "Diff. Expressed")+
    geom_point(aes(colour = if_else(padj <= input$fdr,"yes","no")),
               alpha = .75,size = input$ps)+
    geom_text_repel(data = gene_data,aes(label = gene_id),colour = "black",
                    size = 4)+
    coord_cartesian(
      xlim = MA1_ranges$x,
      ylim = MA1_ranges$y
    )
})

fillCol(flex = c(1,NA),
        plotOutput("MA1",
                   click = "MA1_click",
                   dblclick = "MA1_dblclick",
                   brush = brushOpts(
                     id = "MA1_brush",
                     resetOnNew = TRUE
                     ))
        )

```

### MA - data

```{r , ma_tpm}

MA2_ranges <- reactiveValues(x = NULL, y = NULL)

observeEvent(input$MA2_dblclick, {
  brush <- input$MA2_brush
  if (!is.null(brush)) {
    MA2_ranges$x <- c(brush$xmin, brush$xmax)
    MA2_ranges$x[1] <- max(0 , MA1_ranges$x[1])
    MA2_ranges$y <- c(brush$ymin, brush$ymax)
  } else {
    MA2_ranges$x <- NULL
    MA2_ranges$y <- NULL
  }
})

observeEvent(input$MA2_click,{
  ff <- nearPoints(diff_genes,input$MA2_click)
  my_genes$ensembl <- c(my_genes$ensembl, ff$ensembl)
})

output$MA2 = renderPlot({
  
  gene_data = diff_genes %>% 
    filter(ensembl %in% my_genes$ensembl)
  
  diff_genes %>% 
    ggplot(aes(A,M))+
    scale_color_brewer(palette = "Set1", name = "Diff. Expressed")+
    geom_point(aes(colour = if_else(padj <= input$fdr,"yes","no")),
               alpha = .75,size = input$ps)+
    geom_text_repel(data = gene_data,aes(label = gene_id),colour = "black",
                    size = 4)+
    coord_cartesian(
      xlim = MA2_ranges$x,
      ylim = MA2_ranges$y
    )
})

fillCol(flex = c(1,NA),
        plotOutput("MA2",
                   click = "MA2_click",
                   dblclick = "MA2_dblclick",
                   brush = brushOpts(
                     id = "MA2_brush",
                     resetOnNew = TRUE
                     ))
        )


```



### Model heatmap

```{r model_heatmap}

renderD3heatmap({
  
  my_mat = rlogmat1
  
  if(input$heatmap_type == "most DE"){
    genes = diff_genes %>% 
      arrange(desc(log10pval)) %>% 
      head(input$heatmap_most )
    
      idx = genes %>% 
        mutate(
          idx = paste(ensembl,gene_id,sep = "_")
        ) %>% 
        pluck("idx")
      my_mat = my_mat[rownames(my_mat) %in% idx, ]
    
  }else{
    if(is.null(my_genes$ensembl)){
      my_mat = my_mat[sample(nrow(my_mat),3),]
    }else{
      genes = diff_genes %>% 
        filter(ensembl %in% my_genes$ensembl)
    
      idx = genes %>% 
        mutate(
          idx = paste(ensembl,gene_id,sep = "_")
        ) %>% 
        pluck("idx")
      my_mat = my_mat[rownames(my_mat) %in% idx, ]
    }
    
  }
  rownames(my_mat) = rownames(my_mat) %>% 
    str_split("_") %>% 
    map_chr( ~ .[2])
  
  colnames(my_mat) = colnames(my_mat) %>% 
    str_replace("RNAseq-","")
  
  pal = viridis(100)
  
  d3heatmap(my_mat,
            colors = pal,
            xaxis_font_size = 12,
            yaxis_font_size = 12)
})


```

### TPM heatmap

```{r tpm_heatmap}

renderD3heatmap({
  
  my_mat = tpmmat1
  
  if(input$heatmap_type == "most DE"){
    genes = diff_genes %>% 
      arrange(desc(log10pval)) %>% 
      head(input$heatmap_most )
    
      idx = genes %>% 
        mutate(
          idx = paste(ensembl,gene_id,sep = "_")
        ) %>% 
        pluck("idx")
      my_mat = my_mat[rownames(my_mat) %in% idx, ]
    
  }else{
    if(is.null(my_genes$ensembl)){
      my_mat = my_mat[sample(nrow(my_mat),3),]
    }else{
      genes = diff_genes %>% 
        filter(ensembl %in% my_genes$ensembl)
    
      idx = genes %>% 
        mutate(
          idx = paste(ensembl,gene_id,sep = "_")
        ) %>% 
        pluck("idx")
      my_mat = my_mat[rownames(my_mat) %in% idx, ]
    }
    
  }
  rownames(my_mat) = rownames(my_mat) %>% 
    str_split("_") %>% 
    map_chr( ~ .[2])
  
  colnames(my_mat) = colnames(my_mat) %>% 
    str_replace("RNAseq-","")
  
  pal = viridis(100)
  
  d3heatmap(my_mat,
            scale = "row",
            colors = pal,
            xaxis_font_size = 12,
            yaxis_font_size = 12)
})

```

### Genes table

```{r table}  
##actionLink("generate","Generate gene list!")

div(
  renderDataTable(
    diff_genes %>% 
      filter(ensembl %in% my_genes$ensembl) %>% 
      select(gene_id,ensembl,padj,log10pval,EBV,NOKS,stat),
    options = list(
      pageLength = 10,
      lengthMenu = c(10,20,50,100)
    ) ) ,style = "font-size:80%")

```

### Instructions

**Alignment** - This plot is fixed, I think for the supplement

**p.value** - Also fixed, there is a deviation of the multiple testing assumptions

**volcano** and **MA plots** - In these three, can click the point and build a table of DE genes. To change the scale of the figure: brush and double click. If you double click without brush that will restart to the initial plot. Just click on a gene to label it, the results are stored in both **heatmaps** and **Gene table**.

===

**Sidebar**

* False discovery rate: The smaller, the test results are more conservative

* Point size: Just to make the plots to look just right

* Clean gene list: To start over again




```{r}
renderText({
  "File saved in ..."
})
```



